---
title: "Data_Wrangling"
output: html_document
date: "2025-11-14"
---

```{r setup, include=FALSE}
library(readr)
library(dplyr)
library(tidyr)
library(stringr)
library(writexl)   

# Helper function to normalize names
normalize_name <- function(x) {
  x %>%
    str_to_lower() %>%                 # lowercase
    str_squish() %>%                   # trim whitespace
    str_replace_all("\\.", "") %>%     # remove periods (A.J. -> aj)
    iconv(from = "", to = "ASCII//TRANSLIT") %>%  # remove accents (MÃ¡rquez -> Marquez)
    str_replace_all("['`]", "") %>%    # remove stray apostrophes
    str_squish()
}

 
 
# 1. Read data
pitch_vel <- read_csv("pitch_velocity_master.csv")
people    <- read_csv("people.csv")




# 2. Clean pitch velocity + movement data
#    (year, last_name, first_name, avg_speed, pitch_type, pitch_type_name, induced_vertical_break, induced_horizontal_break)
pitch_vel_clean <- pitch_vel %>%
  separate(
    col  = "last_name, first_name",
    into = c("nameLast_raw", "nameFirst_raw"),
    sep  = ",\\s*",
    remove = FALSE
  ) %>%
  mutate(
    nameLast  = normalize_name(nameLast_raw),
    nameFirst = normalize_name(nameFirst_raw)
  )




# 3. Clean People dataset
people_clean <- people %>%
  mutate(
    nameLast  = normalize_name(nameLast),
    nameFirst = normalize_name(nameFirst)
  ) %>%
  select(playerID, nameFirst, nameLast, birthYear)

# Keep only unique name combinations to avoid ambiguous matches
people_unique <- people_clean %>%
  add_count(nameFirst, nameLast, name = "n_name") %>%
  filter(n_name == 1) %>%             # keep only names mapping to a single player
  select(-n_name)




# 4. Join pitch data with playerID
pitch_vel_with_id <- pitch_vel_clean %>%
  left_join(
    people_unique,
    by = c("nameFirst", "nameLast")
  )

# Check unmatched rows
unmatched_names <- pitch_vel_with_id %>%
  filter(is.na(playerID)) %>%
  distinct(nameFirst, nameLast)

unmatched_names

# Remove players that did not have an ID match
pitch_vel_final <- pitch_vel_with_id %>%
  filter(!is.na(playerID))



# 5. Keep only the 4 pitch types and build wide velocity + IVB + IHB tables
pitch_vel_filtered <- pitch_vel_final %>%
  filter(pitch_type %in% c("FF", "SL", "CH", "CU"))

# (a) Velocity wide: FF_vel, SL_vel, CH_vel, CU_vel
vel_wide <- pitch_vel_filtered %>%
  mutate(
    pitch_col = recode(
      pitch_type,
      "FF" = "FF_vel",
      "SL" = "SL_vel",
      "CH" = "CH_vel",
      "CU" = "CU_vel"
    )
  ) %>%
  group_by(year, playerID, pitch_col) %>%
  summarise(
    avg_speed = mean(avg_speed, na.rm = TRUE),
    .groups   = "drop"
  ) %>%
  pivot_wider(
    names_from  = pitch_col,
    values_from = avg_speed
  )

# (b) Induced vertical break wide: FF_ivb, SL_ivb, CH_ivb, CU_ivb
ivb_wide <- pitch_vel_filtered %>%
  mutate(
    pitch_col = recode(
      pitch_type,
      "FF" = "FF_ivb",
      "SL" = "SL_ivb",
      "CH" = "CH_ivb",
      "CU" = "CU_ivb"
    )
  ) %>%
  group_by(year, playerID, pitch_col) %>%
  summarise(
    ivb = mean(induced_vertical_break, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from  = pitch_col,
    values_from = ivb
  )

# (c) Induced horizontal break wide: FF_ihb, SL_ihb, CH_ihb, CU_ihb
ihb_wide <- pitch_vel_filtered %>%
  mutate(
    pitch_col = recode(
      pitch_type,
      "FF" = "FF_ihb",
      "SL" = "SL_ihb",
      "CH" = "CH_ihb",
      "CU" = "CU_ihb"
    )
  ) %>%
  group_by(year, playerID, pitch_col) %>%
  summarise(
    ihb = mean(induced_horizontal_break, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from  = pitch_col,
    values_from = ihb
  )

# Combine velocity + IVB + IHB into one wide table
pitch_movement_wide <- vel_wide %>%
  left_join(ivb_wide, by = c("year", "playerID")) %>%
  left_join(ihb_wide, by = c("year", "playerID")) %>%
  rename(yearID = year)




# 6. Read Lahman Pitching and AwardsSharePlayers
pitching <- read_csv("Pitching.csv")
awards   <- read_csv("AwardsSharePlayers.csv")

# years to keep (2017-2023, excluding 2020)
keep_years <- c(2017, 2018, 2019, 2021, 2022, 2023)




# 7. Prep Pitching: filter years, remove team-changers, keep qualified pitchers (>= 50 IP)
pitching_clean <- pitching %>%
  filter(yearID %in% keep_years) %>%
  # compute innings pitched from IPouts (3 outs per inning)
  mutate(IP = IPouts / 3) %>%
  # remove players who changed teams midseason
  group_by(playerID, yearID) %>%
  filter(n_distinct(teamID) == 1) %>%   # only 1 team for that year
  ungroup() %>%
  # keep only what's needed to define qualification (we don't retain ERA, etc.)
  select(playerID, yearID, teamID, IP) %>%
  # filter for qualified pitchers: at least 50 IP
  filter(IP >= 50)




# 8. Prep Cy Young awards data
awards_cy <- awards %>%
  filter(awardID == "Cy Young Award",
         yearID %in% keep_years) %>%
  group_by(playerID, yearID) %>%
  summarise(
    pointsWon = sum(pointsWon, na.rm = TRUE),
    .groups   = "drop"
  )




# 9. Merge Pitching + Pitch Movement + Awards
pitch_vars <- c(
  "FF_vel", "SL_vel", "CH_vel", "CU_vel",
  "FF_ivb", "SL_ivb", "CH_ivb", "CU_ivb",
  "FF_ihb", "SL_ihb", "CH_ihb", "CU_ihb"
)

master_data <- pitching_clean %>%
  inner_join(pitch_movement_wide,
             by = c("playerID", "yearID")) %>%
  left_join(awards_cy,
            by = c("playerID", "yearID")) %>%
  mutate(
    pointsWon = if_else(is.na(pointsWon), 0, pointsWon),
    Vote_Flag = if_else(pointsWon > 0, 1, 0)
  ) %>%
  # require non-missing for all pitch-level variables
  filter(if_all(all_of(pitch_vars), ~ !is.na(.))) %>%
  # keep only ID + pitch-level predictors + voting variables
  select(
    playerID, yearID,
    all_of(pitch_vars),
    pointsWon, Vote_Flag
  ) %>%
  mutate(delta_FF_CH = FF_vel - CH_vel,
            delta_FF_CU = FF_vel - CU_vel)




# 10. Checks
dim(master_data)               # how many pitchers x vars?
table(master_data$yearID)      # counts by season
table(master_data$Vote_Flag)   # how many got votes vs not




# 11. Save master_data as Excel file
write_xlsx(master_data, "master_data.xlsx")
```


